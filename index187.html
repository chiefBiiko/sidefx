<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>chains</title>
    <script>
      // entry point
      function initChainGame() {
        'use strict'
        const body = document.querySelector('body')
        var interval_id // interval reference
        // std helpers
        function randomArrayPick(array) {
          return array[Math.floor(Math.random() * array.length)]
        }
        function randomIntInRange(min, max) { // min and max are inclusive
          const minceil = Math.ceil(min)
          const maxflo = Math.floor(max)
          return Math.floor(Math.random() * (maxflo - minceil + 1) + minceil)
        }
        // helper called in interval to manage animation of all chains
        function updateChains(chainclass='_chain') {
          const chains = Array.from(document.getElementsByClassName(chainclass))
          if (chains.length !== 0) {
            chains.forEach(chain => {
              // setting y position
              chain._top = chain._top + chain._speed
              chain.style.top = `${chain._top}px`
              // alternating rotation direction
              Math.abs(chain._rotationAngle) >= 25 ?
                chain._rotationDirection *= -1 : chain._rotationDirection *= 1
              chain._rotationAngle += chain._speed * chain._rotationDirection
              // chain swanging
              chain.style.transform = `rotate(${chain._rotationAngle}deg)`
               // toss once out of bounds
              if (chain._top > window.innerHeight) {
                chain.parentNode.removeChild(chain)
              }
            })
          } else { // render new chains
            const num_chains = randomIntInRange(1, 5)
            for (let i = 0; i < num_chains; i++) {
              const edge = randomIntInRange(20, 50)
              const worth = randomIntInRange(edge / 2, edge * 2)
              body.appendChild(makeChain('_chain', edge, edge, worth))
            }
          }
        }
        // helper that destroys and kills all chains
        function destroyChains(chainclass='_chain') {
          const chains = Array.from(document.getElementsByClassName(chainclass))
          chains.forEach(chain => chain.parentNode.removeChild(chain))
        }
        // chain factory
        function makeChain(chainclass='_chain', width=40, height=40, worth=10) {
          const chain = document.createElement('div')
          chain.className = chainclass
          chain._worth = worth
          chain._speed = randomIntInRange(1, 2)
          chain._rotationAngle = 0
          chain._rotationDirection = 1
          // chain styling
          chain.style.zIndex = 9999
          chain.style.backgroundColor = '#FFD000'
          chain.style.cursor = 'crosshair'
          chain.style.width = `${width}px`
          chain.style.height = `${height}px`
          // positioning - set a quasi-random position within the viewport
          chain.style.position = 'fixed'
          chain.style.top = `${randomIntInRange(-height, 0)}px`
          chain.style.left =
            `${randomIntInRange(0, window.innerWidth - width)}px`
          // setting numeric position attributes for less parsing in interval
          chain._top = parseInt(chain.style.top)
          // register a click handler for the new element
          chain.onclick = function(e) { // this === chain
            const score = document.querySelector('#_chainrain-score')
            body.appendChild(makeHitBubble(this._worth,
                                          this.style.top,
                                          this.style.left))
            score._score += this._worth
            score.innerText = `${score._score}`
            this.parentNode.removeChild(this)
          }
          // factory return
          return chain
        }
        // hit bubble factory
        function makeHitBubble(worth, top, left) {
          const bubble = document.createElement('span')
          // bubble ...styling
          bubble.innerText = `${worth}$€`
          bubble.style.zIndex = 10000
          bubble.style.position = 'fixed'
          bubble.style.left = left
          bubble.style.top = top
          bubble.style.backgroundColor = '#fff'
          window.setTimeout(() => {
            bubble.parentNode.removeChild(bubble)
          }, 1000)
          // factory return
          return bubble
        }
        // controls factory
        function makeControls() {
          const container = document.createElement('div')
          const toggler = document.createElement('button') // playback toggler
          const scoreboard = document.createElement('div')
          const score = document.createElement('div')
          // container styling
          container.style.zIndex = 10000
          container.style.display = 'inline-block'
          container.style.position = 'fixed'
          container.style.right = '10px'
          // toggler styling
          toggler.innerText = 'play chain rain!'
          toggler.style.cursor = 'pointer'
          // scoreboard and score ...styling
          scoreboard.innerText = '©@$h:'
          score.id = '_chainrain-score'
          score.innerText = '0'
          score._score = 0
          // a little logic
          toggler.playing = false
          toggler.onclick = function() { // this === toggler
            if (this.playing) { // stop and kill all chains
              window.clearInterval(interval_id)
              destroyChains('_chain')
              this.playing = false
              this.innerText = 'play chain rain!'
            } else {
              const num_chains = randomIntInRange(1, 5)
              for (let i = 0; i < num_chains; i++) {
                const edge = randomIntInRange(20, 50)
                const worth = randomIntInRange(edge / 2, edge * 2)
                body.appendChild(makeChain('_chain', edge, edge, worth))
              }
              interval_id =
                window.setInterval(updateChains.bind(null, '_chain'), 50)
              this.playing = true
              this.innerText = 'stop chain rain!'
            }
          }
          // assembling controls
          scoreboard.appendChild(score)
          container.appendChild(toggler)
          container.appendChild(scoreboard)
          // factory return
          return container
        }
        body.appendChild(makeControls())
      }
      window.onload = initChainGame
    </script>
  </head>
  <body></body>
</html>
